{"version":3,"file":"index-Dp5EZbji.js","sources":["../../src/filters/base-filter.ts","../../src/filters/css-filters.ts","../../src/filters/index.ts"],"sourcesContent":["/**\n * 滤镜配置接口\n */\nexport interface FilterConfig {\n  [key: string]: any;\n}\n\n/**\n * 滤镜基类\n */\nexport abstract class BaseFilter {\n  /**\n   * 滤镜名称\n   */\n  abstract name: string;\n\n  /**\n   * 应用滤镜到VideoFrame\n   * @param frame 原始VideoFrame\n   * @param config 滤镜配置\n   * @returns 处理后的VideoFrame\n   */\n  abstract apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame>;\n\n  /**\n   * 关闭滤镜资源\n   */\n  dispose(): void {\n    // 默认实现，子类可重写\n  }\n}\n\n/**\n * 滤镜管理器类\n */\nexport class FilterManager {\n  private filters: Map<string, BaseFilter> = new Map();\n\n  /**\n   * 注册滤镜\n   * @param filter 滤镜实例\n   */\n  registerFilter(filter: BaseFilter): void {\n    this.filters.set(filter.name, filter);\n  }\n\n  /**\n   * 获取滤镜实例\n   * @param name 滤镜名称\n   * @returns 滤镜实例\n   */\n  getFilter(name: string): BaseFilter | undefined {\n    return this.filters.get(name);\n  }\n\n  /**\n   * 应用多个滤镜到VideoFrame\n   * @param frame 原始VideoFrame\n   * @param filterNames 滤镜名称列表\n   * @param configs 滤镜配置列表，与filterNames一一对应\n   * @returns 处理后的VideoFrame\n   */\n  async applyFilters(frame: VideoFrame, filterNames: string[], configs: FilterConfig[] = []): Promise<VideoFrame> {\n    let currentFrame = frame;\n    let isOriginalFrame = true;\n\n    try {\n      for (let i = 0; i < filterNames.length; i++) {\n        const filterName = filterNames[i];\n        const filter = this.getFilter(filterName);\n\n        if (filter) {\n          const config = configs[i] || {};\n          const newFrame = await filter.apply(currentFrame, config);\n\n          if (!isOriginalFrame) {\n            currentFrame.close();\n          }\n\n          currentFrame = newFrame;\n          isOriginalFrame = false;\n        }\n      }\n\n      return currentFrame;\n    } catch (error) {\n      console.error('Error applying filters:', error);\n      if (!isOriginalFrame) {\n        currentFrame.close();\n      }\n      return frame.clone();\n    }\n  }\n\n  /**\n   * 关闭滤镜管理器，释放所有滤镜资源\n   */\n  dispose(): void {\n    for (const filter of this.filters.values()) {\n      filter.dispose();\n    }\n    this.filters.clear();\n  }\n}\n","import { BaseFilter, type FilterConfig } from './base-filter';\n\n/**\n * CSS滤镜类\n * 使用CSS filter属性对VideoFrame进行处理\n */\nexport class CSSFilter extends BaseFilter {\n  name = 'css-filter';\n  private canvas: OffscreenCanvas;\n  private ctx: OffscreenCanvasRenderingContext2D;\n\n  constructor() {\n    super();\n    this.canvas = new OffscreenCanvas(1, 1);\n    this.ctx = this.canvas.getContext('2d')!;\n  }\n\n  /**\n   * 应用CSS滤镜到VideoFrame\n   * @param frame 原始VideoFrame\n   * @param config 滤镜配置，包含filter属性\n   * @returns 处理后的VideoFrame\n   */\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const { filter = '' } = config;\n\n    // 如果没有滤镜，直接返回原始帧的副本\n    if (!filter) {\n      return frame.clone();\n    }\n\n    // 调整canvas大小以匹配帧大小\n    const width = frame.displayWidth;\n    const height = frame.displayHeight;\n    this.canvas.width = width;\n    this.canvas.height = height;\n\n    // 绘制原始帧到canvas\n    this.ctx.filter = 'none'; // 确保初始没有滤镜\n    this.ctx.drawImage(frame, 0, 0, width, height);\n\n    // 应用CSS滤镜\n    this.ctx.filter = filter;\n    this.ctx.drawImage(frame, 0, 0, width, height);\n    this.ctx.filter = 'none'; // 重置滤镜\n\n    // 创建新的VideoFrame\n    const filteredFrame = new VideoFrame(this.canvas, {\n      timestamp: frame.timestamp,\n      duration: frame.duration || undefined,\n    });\n\n    return filteredFrame;\n  }\n\n  /**\n   * 关闭滤镜资源\n   */\n  dispose(): void {\n    super.dispose();\n    // 释放canvas资源\n    this.canvas.width = 0;\n    this.canvas.height = 0;\n  }\n}\n\n/**\n * 灰度滤镜\n */\nexport class GrayscaleFilter extends BaseFilter {\n  name = 'grayscale';\n\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const cssFilter = new CSSFilter();\n    const result = await cssFilter.apply(frame, {\n      filter: `grayscale(${config.amount || 0}%)`\n    });\n    cssFilter.dispose();\n    return result;\n  }\n}\n\n/**\n * 模糊滤镜\n */\nexport class BlurFilter extends BaseFilter {\n  name = 'blur';\n\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const cssFilter = new CSSFilter();\n    const result = await cssFilter.apply(frame, {\n      filter: `blur(${config.amount / 100 * 5}px)`\n    });\n    cssFilter.dispose();\n    return result;\n  }\n}\n\n/**\n * 亮度滤镜\n */\nexport class BrightnessFilter extends BaseFilter {\n  name = 'brightness';\n\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const cssFilter = new CSSFilter();\n    const result = await cssFilter.apply(frame, {\n      filter: `brightness(${config.amount || 0}%)`\n    });\n    cssFilter.dispose();\n    return result;\n  }\n}\n\n/**\n * 对比度滤镜\n */\nexport class ContrastFilter extends BaseFilter {\n  name = 'contrast';\n\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const cssFilter = new CSSFilter();\n    const result = await cssFilter.apply(frame, {\n      filter: `contrast(${config.amount || 0}%)`\n    });\n    cssFilter.dispose();\n    return result;\n  }\n}\n\n/**\n * 饱和度滤镜\n */\nexport class SaturateFilter extends BaseFilter {\n  name = 'saturate';\n\n  async apply(frame: VideoFrame, config: FilterConfig): Promise<VideoFrame> {\n    const cssFilter = new CSSFilter();\n    const result = await cssFilter.apply(frame, {\n      filter: `saturate(${config.amount || 200}%)`\n    });\n    cssFilter.dispose();\n    return result;\n  }\n}\n","// 导入基础类和类型\nimport { BaseFilter, FilterManager, type FilterConfig } from './base-filter';\n\n// 导入滤镜实现\nimport {\n  CSSFilter,\n  GrayscaleFilter,\n  BlurFilter,\n  BrightnessFilter,\n  ContrastFilter,\n  SaturateFilter\n} from './css-filters';\n\n// 重新导出基础类和类型\nexport { BaseFilter, FilterManager, type FilterConfig };\n\n// 创建全局滤镜管理器实例\nexport const filterManager = new FilterManager();\n\n// 注册内置滤镜\nfilterManager.registerFilter(new CSSFilter());\nfilterManager.registerFilter(new GrayscaleFilter());\nfilterManager.registerFilter(new BlurFilter());\nfilterManager.registerFilter(new BrightnessFilter());\nfilterManager.registerFilter(new ContrastFilter());\nfilterManager.registerFilter(new SaturateFilter());\n"],"names":["BaseFilter","FilterManager","__publicField","filter","name","frame","filterNames","configs","currentFrame","isOriginalFrame","i","filterName","config","newFrame","error","CSSFilter","width","height","GrayscaleFilter","cssFilter","result","BlurFilter","BrightnessFilter","ContrastFilter","SaturateFilter","filterManager"],"mappings":"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"}